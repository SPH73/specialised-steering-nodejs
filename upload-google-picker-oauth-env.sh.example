#!/bin/bash
# This is a template file. The actual file with real server credentials is:
# upload-google-picker-oauth-env.sh (ignored in .gitignore)
# Copy this file to upload-google-picker-oauth-env.sh and replace placeholders with actual values.

# Script to upload Google Photos Picker OAuth environment variables to staging and production servers
# Run this from your local machine: ./upload-google-picker-oauth-env.sh

set -e  # Exit on error

echo "üîê Uploading Google Photos Picker OAuth environment variables to servers"
echo "=" | head -c 60; echo ""

# Extract values from credentials.json
if [ ! -f credentials.json ]; then
    echo "‚ùå Error: credentials.json not found"
    exit 1
fi

# Try both 'web' and 'installed' formats (Google OAuth can use either)
GOOGLE_CLIENT_ID=$(python3 -c "
import json, sys
data = json.load(open('credentials.json'))
if 'web' in data:
    print(data['web']['client_id'])
elif 'installed' in data:
    print(data['installed']['client_id'])
else:
    sys.exit(1)
")
GOOGLE_CLIENT_SECRET=$(python3 -c "
import json, sys
data = json.load(open('credentials.json'))
if 'web' in data:
    print(data['web']['client_secret'])
elif 'installed' in data:
    print(data['installed']['client_secret'])
else:
    sys.exit(1)
")
GOOGLE_REDIRECT_URI="https://www.specialisedsteering.com/oauth2callback"

echo "üìã Values to upload:"
echo "  GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}"
echo "  GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:0:20}..."
echo "  GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}"
echo ""

# Server details - REPLACE WITH YOUR ACTUAL VALUES
SERVER="YOUR_USERNAME@YOUR_SERVER_IP"
PORT="YOUR_SSH_PORT"
PROD_DIR="~/YOUR_PRODUCTION_DIRECTORY"
STAGING_DIR="~/YOUR_STAGING_DIRECTORY"

# Function to update .htaccess on server
update_server_htaccess() {
    local SERVER_DIR=$1
    local SERVER_NAME=$2

    echo ""
    echo "üì§ Updating ${SERVER_NAME}..."

    ssh -p ${PORT} ${SERVER} << EOF
        cd ${SERVER_DIR}

        # Backup .htaccess
        cp .htaccess .htaccess.backup.\$(date +%Y%m%d_%H%M%S)

        # Update or add GOOGLE_CLIENT_ID
        if grep -q "SetEnv GOOGLE_CLIENT_ID" .htaccess; then
            sed -i.tmp 's|SetEnv GOOGLE_CLIENT_ID.*|SetEnv GOOGLE_CLIENT_ID ${GOOGLE_CLIENT_ID}|g' .htaccess
            echo "‚úÖ Updated GOOGLE_CLIENT_ID"
        else
            # Add before closing </IfModule> tag
            sed -i.tmp '/<\/IfModule>/i\
SetEnv GOOGLE_CLIENT_ID ${GOOGLE_CLIENT_ID}
' .htaccess
            echo "‚úÖ Added GOOGLE_CLIENT_ID"
        fi

        # Update or add GOOGLE_CLIENT_SECRET
        if grep -q "SetEnv GOOGLE_CLIENT_SECRET" .htaccess; then
            sed -i.tmp 's|SetEnv GOOGLE_CLIENT_SECRET.*|SetEnv GOOGLE_CLIENT_SECRET ${GOOGLE_CLIENT_SECRET}|g' .htaccess
            echo "‚úÖ Updated GOOGLE_CLIENT_SECRET"
        else
            sed -i.tmp '/<\/IfModule>/i\
SetEnv GOOGLE_CLIENT_SECRET ${GOOGLE_CLIENT_SECRET}
' .htaccess
            echo "‚úÖ Added GOOGLE_CLIENT_SECRET"
        fi

        # Update or add GOOGLE_REDIRECT_URI
        if grep -q "SetEnv GOOGLE_REDIRECT_URI" .htaccess; then
            sed -i.tmp 's|SetEnv GOOGLE_REDIRECT_URI.*|SetEnv GOOGLE_REDIRECT_URI ${GOOGLE_REDIRECT_URI}|g' .htaccess
            echo "‚úÖ Updated GOOGLE_REDIRECT_URI"
        else
            sed -i.tmp '/<\/IfModule>/i\
SetEnv GOOGLE_REDIRECT_URI ${GOOGLE_REDIRECT_URI}
' .htaccess
            echo "‚úÖ Added GOOGLE_REDIRECT_URI"
        fi

        # Clean up temp file
        rm -f .htaccess.tmp

        # Verify
        echo ""
        echo "üìã Verification:"
        grep -E "(GOOGLE_CLIENT_ID|GOOGLE_CLIENT_SECRET|GOOGLE_REDIRECT_URI)" .htaccess

        # Restart Passenger
        touch tmp/restart.txt
        echo "‚úÖ Restarted Passenger"
EOF
}

# Ask which servers to update
echo "Which servers do you want to update?"
echo "  1) Production only"
echo "  2) Staging only"
echo "  3) Both (production and staging)"
read -p "Enter choice (1-3): " choice

case $choice in
    1)
        update_server_htaccess "${PROD_DIR}" "Production"
        ;;
    2)
        update_server_htaccess "${STAGING_DIR}" "Staging"
        ;;
    3)
        update_server_htaccess "${PROD_DIR}" "Production"
        update_server_htaccess "${STAGING_DIR}" "Staging"
        ;;
    *)
        echo "‚ùå Invalid choice"
        exit 1
        ;;
esac

echo ""
echo "‚úÖ Done! Google Photos Picker OAuth environment variables have been updated on the selected servers."
echo ""

