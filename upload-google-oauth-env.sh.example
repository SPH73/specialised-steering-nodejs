#!/bin/bash
# This is a template file. The actual file with real server credentials is:
# upload-google-oauth-env.sh (ignored in .gitignore)
# Copy this file to upload-google-oauth-env.sh and replace placeholders with actual values.

# Script to upload Google OAuth environment variables to staging and production servers
# Run this from your local machine: ./upload-google-oauth-env.sh

set -e  # Exit on error

echo "üîê Uploading Google OAuth environment variables to servers"
echo "=" | head -c 60; echo ""

# Extract values from credentials.json
if [ ! -f credentials.json ]; then
    echo "‚ùå Error: credentials.json not found"
    exit 1
fi

CLIENT_ID=$(python3 -c "import json; print(json.load(open('credentials.json'))['installed']['client_id'])")
CLIENT_SECRET=$(python3 -c "import json; print(json.load(open('credentials.json'))['installed']['client_secret'])")
REDIRECT_URIS="http://localhost:3300/oauth2callback,https://YOUR_STAGING_DOMAIN/oauth2callback,https://YOUR_PRODUCTION_DOMAIN/oauth2callback"

# Get album ID from .env file if it exists
if [ -f .env ]; then
    ALBUM_ID=$(grep "^GOOGLE_PHOTOS_ALBUM_ID=" .env | cut -d '=' -f2 | tr -d '"' | tr -d "'" || echo "")
fi

# If not in .env, use placeholder
if [ -z "$ALBUM_ID" ]; then
    ALBUM_ID="YOUR_ALBUM_ID"
    echo "‚ö†Ô∏è  Album ID not found in .env, using placeholder: ${ALBUM_ID}"
fi

echo "üìã Values to upload:"
echo "  CLIENT_ID: ${CLIENT_ID}"
echo "  CLIENT_SECRET: ${CLIENT_SECRET:0:20}..."
echo "  REDIRECT_URIS: ${REDIRECT_URIS}"
echo "  GOOGLE_PHOTOS_ALBUM_ID: ${ALBUM_ID}"
echo ""

# Server details - REPLACE WITH YOUR ACTUAL VALUES
SERVER="YOUR_USERNAME@YOUR_SERVER_IP"
PORT="YOUR_SSH_PORT"
PROD_DIR="~/YOUR_PRODUCTION_DIRECTORY"
STAGING_DIR="~/YOUR_STAGING_DIRECTORY"

# Function to update .htaccess on server
update_server_htaccess() {
    local SERVER_DIR=$1
    local SERVER_NAME=$2

    echo ""
    echo "üì§ Updating ${SERVER_NAME}..."

    ssh -p ${PORT} ${SERVER} << EOF
        cd ${SERVER_DIR}

        # Backup .htaccess
        cp .htaccess .htaccess.backup.\$(date +%Y%m%d_%H%M%S)

        # Update or add CLIENT_ID
        if grep -q "SetEnv CLIENT_ID" .htaccess; then
            sed -i.tmp 's|SetEnv CLIENT_ID.*|SetEnv CLIENT_ID ${CLIENT_ID}|g' .htaccess
            echo "‚úÖ Updated CLIENT_ID"
        else
            # Add before closing </IfModule> tag
            sed -i.tmp '/<\/IfModule>/i\
SetEnv CLIENT_ID ${CLIENT_ID}
' .htaccess
            echo "‚úÖ Added CLIENT_ID"
        fi

        # Update or add CLIENT_SECRET
        if grep -q "SetEnv CLIENT_SECRET" .htaccess; then
            sed -i.tmp 's|SetEnv CLIENT_SECRET.*|SetEnv CLIENT_SECRET ${CLIENT_SECRET}|g' .htaccess
            echo "‚úÖ Updated CLIENT_SECRET"
        else
            sed -i.tmp '/<\/IfModule>/i\
SetEnv CLIENT_SECRET ${CLIENT_SECRET}
' .htaccess
            echo "‚úÖ Added CLIENT_SECRET"
        fi

        # Update or add REDIRECT_URIS
        if grep -q "SetEnv REDIRECT_URIS" .htaccess; then
            sed -i.tmp 's|SetEnv REDIRECT_URIS.*|SetEnv REDIRECT_URIS "${REDIRECT_URIS}"|g' .htaccess
            echo "‚úÖ Updated REDIRECT_URIS"
        else
            sed -i.tmp '/<\/IfModule>/i\
SetEnv REDIRECT_URIS "${REDIRECT_URIS}"
' .htaccess
            echo "‚úÖ Added REDIRECT_URIS"
        fi

        # Update or add GOOGLE_PHOTOS_ALBUM_ID
        if grep -q "SetEnv GOOGLE_PHOTOS_ALBUM_ID" .htaccess; then
            sed -i.tmp "s|SetEnv GOOGLE_PHOTOS_ALBUM_ID.*|SetEnv GOOGLE_PHOTOS_ALBUM_ID ${ALBUM_ID}|g" .htaccess
            echo "‚úÖ Updated GOOGLE_PHOTOS_ALBUM_ID"
        else
            sed -i.tmp "/<\/IfModule>/i\\
SetEnv GOOGLE_PHOTOS_ALBUM_ID ${ALBUM_ID}
" .htaccess
            echo "‚úÖ Added GOOGLE_PHOTOS_ALBUM_ID"
        fi

        # Clean up temp file
        rm -f .htaccess.tmp

        # Verify
        echo ""
        echo "üìã Verification:"
        grep -E "(CLIENT_ID|CLIENT_SECRET|REDIRECT_URIS|GOOGLE_PHOTOS_ALBUM_ID)" .htaccess

        # Restart Passenger
        touch tmp/restart.txt
        echo "‚úÖ Restarted Passenger"
EOF
}

# Ask which servers to update
echo "Which servers do you want to update?"
echo "  1) Production only"
echo "  2) Staging only"
echo "  3) Both (production and staging)"
read -p "Enter choice (1-3): " choice

case $choice in
    1)
        update_server_htaccess "${PROD_DIR}" "Production"
        ;;
    2)
        update_server_htaccess "${STAGING_DIR}" "Staging"
        ;;
    3)
        update_server_htaccess "${PROD_DIR}" "Production"
        update_server_htaccess "${STAGING_DIR}" "Staging"
        ;;
    *)
        echo "‚ùå Invalid choice"
        exit 1
        ;;
esac

echo ""
echo "‚úÖ Done! Google OAuth environment variables have been updated on the selected servers."
echo ""
echo "üìù Next steps:"
echo "   1. Test the gallery on the updated servers"
echo "   2. Verify environment variables are loaded correctly"
echo ""

