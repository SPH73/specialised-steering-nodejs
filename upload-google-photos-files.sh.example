#!/bin/bash
# This is a template file. The actual file with real server credentials is:
# upload-google-photos-files.sh (ignored in .gitignore)
# Copy this file to upload-google-photos-files.sh and replace placeholders with actual values.

# Script to upload token.json and credentials.json to staging and production servers
# Run this from your local machine: ./upload-google-photos-files.sh

set -e  # Exit on error

echo "üì§ Uploading Google Photos authentication files to servers"
echo "=" | head -c 60; echo ""

# Check if files exist locally
if [ ! -f token.json ]; then
    echo "‚ö†Ô∏è  Warning: token.json not found locally"
    echo "   Run 'node setup-google-photos-auth.js' first to create it"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Aborted."
        exit 1
    fi
fi

if [ ! -f credentials.json ]; then
    echo "‚ùå Error: credentials.json not found locally"
    exit 1
fi

# Server details - REPLACE WITH YOUR ACTUAL VALUES
SERVER="YOUR_USERNAME@YOUR_SERVER_IP"
PORT="YOUR_SSH_PORT"
PROD_DIR="YOUR_PRODUCTION_DIRECTORY"
STAGING_DIR="YOUR_STAGING_DIRECTORY"

# Function to upload files to a server directory
upload_files() {
    local SERVER_DIR=$1
    local SERVER_NAME=$2

    echo ""
    echo "üì§ Uploading to ${SERVER_NAME}..."

    # Create backup and upload via SSH
    ssh -p ${PORT} ${SERVER} << EOF
        cd ~/${SERVER_DIR}

        # Backup existing files if they exist
        if [ -f token.json ]; then
            cp token.json token.json.backup.\$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backed up existing token.json"
        fi

        if [ -f credentials.json ]; then
            cp credentials.json credentials.json.backup.\$(date +%Y%m%d_%H%M%S)
            echo "‚úÖ Backed up existing credentials.json"
        fi
EOF

    # Upload files
    echo "  Uploading token.json..."
    scp -P ${PORT} token.json ${SERVER}:~/${SERVER_DIR}/token.json

    echo "  Uploading credentials.json..."
    scp -P ${PORT} credentials.json ${SERVER}:~/${SERVER_DIR}/credentials.json

    # Verify files were uploaded
    ssh -p ${PORT} ${SERVER} << EOF
        cd ~/${SERVER_DIR}

        if [ -f token.json ] && [ -f credentials.json ]; then
            echo "‚úÖ Files verified on server"
            ls -lh token.json credentials.json
        else
            echo "‚ùå Error: Files not found after upload"
            exit 1
        fi

        # Restart Passenger
        touch tmp/restart.txt
        echo "‚úÖ Restarted Passenger"
EOF

    echo "‚úÖ ${SERVER_NAME} upload complete"
}

# Ask which servers to update
echo ""
echo "Which servers do you want to update?"
echo "  1) Production only"
echo "  2) Staging only"
echo "  3) Both (production and staging)"
read -p "Enter choice (1-3): " choice

case $choice in
    1)
        upload_files "${PROD_DIR}" "Production"
        ;;
    2)
        upload_files "${STAGING_DIR}" "Staging"
        ;;
    3)
        upload_files "${PROD_DIR}" "Production"
        upload_files "${STAGING_DIR}" "Staging"
        ;;
    *)
        echo "‚ùå Invalid choice"
        exit 1
        ;;
esac

echo ""
echo "‚úÖ Done! Google Photos authentication files have been uploaded."
echo ""
echo "üìù Next steps:"
echo "   1. Upload environment variables: ./upload-google-oauth-env.sh"
echo "   2. Set GOOGLE_PHOTOS_ALBUM_ID on servers (if not already set)"
echo "   3. Test the gallery on the updated servers"
echo ""

